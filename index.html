<html>

<head>
	<style>
		button: {
			margin: 1em;
      display: inline-block;
		}
	</style>
</head>

<body>
	<h1>Testing speech synth on the browser</h1>

	<button onclick="simpleTest()">Simple Test</button>

	<button onclick="init()">Re-init</button>

	<form>
		<input value="hello there"></input>
<select></select>
<button type="submit">speak</button>
</form>
<script>
  console.log('Initializing...');

  function simpleTest() {
    speechSynthesis.speak(new SpeechSynthesisUtterance('What did you say'));
  }

  function speak(text) {
    var msg = new SpeechSynthesisUtterance();
    var voices = speechSynthesis.getVoices();
    msg.voice = voices[0];
    msg.voiceURI = 'native';
    msg.volume = 1; // 0 to 1
    msg.rate = 1; // 0.1 to 10
    msg.pitch = 2; //0 to 2
    msg.text = text;
    msg.lang = 'pl-PL';

    msg.onend = function(e) {
      console.log('Finished in ' + event.elapsedTime + ' seconds.');
    };

    if('speechSynthesis' in window && msg.lang == 'pl-PL') {
        speechSynthesis.speak(msg);
    } else {
        window.open('./info-about-browser.html', 'Info about your browser', 'height=350, width=600, top=200, left=200', 'scrollbars=no', 'resizable=no');
    }
  }

function init() {


  //var synth = window.speechSynthesis;

  var inputForm = document.querySelector('form');
  var inputTxt = document.querySelector('input');
  var voiceSelect = document.querySelector('select');

  var voices = speechSynthesis.getVoices();
  console.log('voices loop', voices.length);
  if (voices.length === 0) {
    alert('No synth voices :(');
    return;
  }

  voices.sort((a, b) => ('' + a.lang).localeCompare(b.lang));

  for (let i = 0; i < voices.length; i++) {
    const voc = voices[i];
    console.log('voc', voc);
    var opt = document.createElement("option");
    opt.value = i;
    opt.innerHTML = voc.lang + ' - ' + voc.name;

    // then append it to the select element
    voiceSelect.appendChild(opt);
  }



  inputForm.onsubmit = function(event) {
    event.preventDefault();

    const text = inputTxt.value;
    var utterThis = new SpeechSynthesisUtterance(text);
    var selectedIndex = +voiceSelect.selectedOptions[0].value;
    console.log("speeaking", text, selectedIndex, utterThis);
    // for(i = 0; i < voices.length ; i++) {
      // if(voices[i].name === selectedOption) {
        // utterThis.voice = voices[i];
      // }
    // }
    // utterThis.lang = 'en-US';
    utterThis.voice = voices[selectedIndex];
    speechSynthesis.speak(utterThis);
    inputTxt.blur();
  }
}


const start = new Date().getTime();
window.speechSynthesis.onvoiceschanged = () => {
  // https://stackoverflow.com/questions/49506716/speechsynthesis-getvoices-returns-empty-array-on-windows
  const end = new Date().getTime();
  const deltaMs = end - start;
  console.warn(`voices are ready ${window.speechSynthesis.getVoices().length} after ${deltaMs} ms`);
  init();
}

</script>
</body>
</html>